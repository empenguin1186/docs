# 安全なWebアプリケーションの作り方

## 文字コードとセキュリティ

### 文字コードを構成する概念を2つ答えよ
- 文字集合と文字エンコーディング

### 文字集合の代表例を対応言語の特徴とビット数も合わせて3つ答えよ
- US-ASCII(7bit): 英語
- JIS X 0208(16bit): 日本語
- Unicode(21bit): 多言語

### 異なる文字が同じコードに割り当てられる問題について述べよ
- Unicode における \ (バックスラッシュ)の符号は、JIS X 0201 では ¥ 記号に割り当てられている。これが原因の脆弱性が存在する。

### 文字エンコーディングの1つであるShift_JISについて、対象の文字集合、特徴、欠点について答えよ
- 対象の文字集合はマイクロソフト標準キャラクタセットである。特徴は、JIS X 0201 の分布の空き領域に JIS X 0208 の文字の値を割り当てる方式を採っているので効率よく文字を表現することができる。
- 欠点は2つ存在する。1つ目は、マルチバイトの先行バイトと後続バイトの分布が一部重なっている部分があるので、単にバイト値を見ただけでは先行バイトなのか後続バイトなのかがわからず文字化けが発生する可能性があるという点である。2つ目は、後続バイトの分布がシングルバイトの特殊文字の領域と重なっている部分があるため、Shift_JISの処理が不完全だと、後続バイトをシングルバイトの特殊文字だと誤認してしまう点である。典型例としては「0x5C」のコード値を持つ「¥」による誤動作がある(5C問題)。

### 文字エンコーディングの1つであるEUC-JPについて、対象の文字集合、特徴、欠点について答えよ
- EUC-JPは日本語を扱えるようにした文字エンコーディングである。US-ASCIIの範囲はそのままの値を扱い、JIS X 0208の日本語を使用する場合は2バイトを使用して表現する。欠点としては、先行バイトと後続バイトの分布が重なっているために、日本語が１バイトずれてマッチするという欠点が存在する

### 文字エンコーディングの1つであるISO-2022-JPについて、対象の文字集合、特徴、欠点について答えよ
- ISO-2022-JPはUS-ASCIIとJIS X 0208の文字集合を扱えるようにした文字コーディングである。エスケープシーケンスという特殊コードを用いることにより文字集合を切り替える。JIS X 0208 に切り替える場合は`ESC$B`、US-ASCIIに切り替える場合は`ESC(B`というエスケープシーケンスを用いて切り替えを行う。ISO-2022-JPは状態を持つので、システムにおける内部処理や検索処理には不向きであるという欠点が存在する。

### Unicodeは現在21bitで表現されているが、元々は16bitで全ての文字を表現する想定であった。元々の16bitの範囲で表現できる文字集合をなんと呼ぶか
- 基本他言語面(BMP)

### 文字エンコーディングの一つであるUTF-16について、BMP以外の文字の表現方法について述べよ
- UTF-16ではBMP以外の文字集合に関してはサロゲートペアを用いて表現する。サロゲートペアとは、2の10乗の領域を2つ確保し、その領域の組み合わせで2の20乗種類の文字を表現する方法である。BMP以外の文字の例は例えば𠮷(つちよし)などがある

### 文字エンコーディングの一つであるUTF-8の特徴について述べよ
- UTF-8 は Unicode の文字集合に対する文字エンコーディング方式で、Unicodeのスカラ値に対してエンコーディング後のデータサイズが可変になるのが特徴である。文字エンコーディング後のデータサイズは1~4バイトになる。また、シングルバイト、マルチバイトの先行バイト、後続バイトの分布が厳密に分かれていることから、Shift-JIS や EUC-JP などに見られる他の文字にマッチしてしまう心配がないのも特徴である。

### UTF-8の非最短形式で文字を表現する場合に発生する脆弱性について述べよ
- /(スラッシュ)をエンコーディングする場合に非最短形式で表現されたデータに関しては/だと認識されない。しかし、そのデータをShift-JISなどの他のエンコーディング方式でデコードした場合に非最短形式であっても/で復号されてしまうため、想定外のディレクトリのファイルをオープンしてしまう可能性がある。

### 文字コードを正しく扱うために気をつけるべきことを述べよ
- アプリケーション全体で使用する文字集合を統一する
- 入力時に不正な文字エンコーディングをエラーにする
- マルチバイトに対応した関数を使い、関数の引数として文字エンコーディングを明示する
- 出力時に文字エンコーディングを正しく指定する
- 文字エンコーディングの自動判定を避ける

## メール送信の脆弱性

### メールヘッダインジェクションについて説明せよ
- メール送信時にメールヘッダの内容に改行を追加することによって、任意のヘッダを設定することができてしまう脆弱性

### メールヘッダインジェクションの脆弱性を解消するための方法を3つ答えよ
- メール送信には専用のAPIやライブラリを使用する
- 外部からのパラメータをメールヘッダに含ませないようにする
- 外部からのパラメータに改行が入っていないかをチェックする

## CSRF

### CSRFとは何か
- 正規のサイトにログインしているユーザが攻撃者が設置したサイトにアクセスすることで、正規のサイトにおける重要な処理(パスワード変更 etc..)を意図せずに実行されてしまう脆弱性のことを指す

### 設計フェーズでのCSRFの対策方法を答えよ
- 要件定義で機能一覧を洗い出したのちに、CSRF対策が必要な機能(商品の購入 etc...)は何があるかを区別しておく

### 実装フェーズでのCSRFの対策方法を3つ答えよ
- アプリケーションでトークンを使用し、重要な機能についてはトークンの検証処理を行う
  - この方法が一般的
- 重要な処理を実行する前にパスワード認証を行う
- Refererを確認して正規の遷移で重要な処理を行う画面にきているかどうかを確認する
  - Referer を送信しないように設定しているブラウザはその機能を使用することができない

## セッションハイジャック

### セッションハイジャックの対応策を4つ答えよ
- セッション管理にはライブラリで提供されているツールを使用する
- クッキーにセッションIDを保存する
- 認証成功時にセッションIDを変更する
- 認証前にはセッション変数に秘密情報を保持しない

## キャッシュコントロール

### アプリケーション-キャッシュサーバ間のキャッシュ機能を実装する際に気をつけることを2点述べよ
- アプリケーション側でキャッシュ制御用の適切なレスポンスヘッダを設定する
  - Cache-Controll, Expiresヘッダ
- キャッシュサーバ側でキャッシュ制御の適切な設定を行う
  - 個人情報などユーザごとに異なる情報に関してはキャッシュしない


